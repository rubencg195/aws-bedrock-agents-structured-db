<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AWS Cognito Sign On Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f7f7f7; }
    .container { max-width: 400px; margin: 0 auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
    .hidden { display: none; }
    label { display: block; margin-top: 1em; }
    textarea { width: 100%; min-height: 80px; }
    button { margin-top: 1em; padding: 0.5em 1.5em; }
    .response { margin-top: 1em; background: #e6f7ff; padding: 1em; border-radius: 4px; }
    .error { color: #b00; margin-top: 1em; }
  </style>
  <!-- AWS Amplify for Cognito Auth (CDN) -->
  <script src="https://unpkg.com/aws-amplify@5.0.4/dist/aws-amplify.min.js"></script>
  <script src="./index.js"></script>
</head>
<body>
  <div class="container">
    <h2>AWS Cognito Sign On Demo</h2>
    <div id="auth-section">
      <form id="signin-form">
        <label for="username">Username</label>
        <input type="text" id="username" required autocomplete="username">
        <label for="password">Password</label>
        <input type="password" id="password" required autocomplete="current-password">
        <button type="submit">Sign In</button>
      </form>
      <div id="auth-error" class="error"></div>
    </div>
    <div id="app-section" class="hidden">
      <div>
        <button id="signout-btn" style="float:right;">Sign Out</button>
        <div style="clear:both;"></div>
      </div>
      <form id="lambda-form">
        <label for="user-input">Enter your text:</label>
        <textarea id="user-input" required></textarea>
        <button type="submit">Submit</button>
      </form>
      <div id="lambda-response" class="response hidden"></div>
      <div id="lambda-error" class="error"></div>
    </div>
  </div>
  <script>
    // TODO: Replace these with your actual Cognito and API values
    const awsConfig = {
      Auth: {
        region: 'us-east-1', // e.g. 'us-east-1'
        userPoolId: 'us-east-1_example', // e.g. 'us-east-1_XXXXXXXXX'
        userPoolWebClientId: 'exampleclientid123456789', // e.g. 'xxxxxxxxxxxxxxxxxxxxxxxxxx'
      }
    };
    const LAMBDA_API_ENDPOINT = 'https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/your-resource'; // <-- Replace with your endpoint

    // Configure Amplify Auth
    window.Amplify.configure(awsConfig);

    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const signinForm = document.getElementById('signin-form');
    const signoutBtn = document.getElementById('signout-btn');
    const authError = document.getElementById('auth-error');
    const lambdaForm = document.getElementById('lambda-form');
    const lambdaResponse = document.getElementById('lambda-response');
    const lambdaError = document.getElementById('lambda-error');

    // Show/hide sections based on auth state
    async function checkAuth() {
      try {
        await window.Amplify.Auth.currentAuthenticatedUser();
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
      } catch {
        authSection.classList.remove('hidden');
        appSection.classList.add('hidden');
      }
    }

    // Sign in handler
    signinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authError.textContent = '';
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        await window.Amplify.Auth.signIn(username, password);
        await checkAuth();
      } catch (err) {
        authError.textContent = err.message || 'Sign in failed';
      }
    });

    // Sign out handler
    signoutBtn.addEventListener('click', async () => {
      await window.Amplify.Auth.signOut();
      await checkAuth();
    });

    // Lambda form handler
    lambdaForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      lambdaError.textContent = '';
      lambdaResponse.classList.add('hidden');
      lambdaResponse.textContent = '';
      try {
        const session = await window.Amplify.Auth.currentSession();
        const idToken = session.getIdToken().getJwtToken();
        const userInput = document.getElementById('user-input').value;
        const response = await fetch(LAMBDA_API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': idToken
          },
          body: JSON.stringify({ input: userInput })
        });
        if (!response.ok) {
          throw new Error('Lambda call failed: ' + response.statusText);
        }
        const data = await response.json();
        lambdaResponse.textContent = JSON.stringify(data, null, 2);
        lambdaResponse.classList.remove('hidden');
      } catch (err) {
        lambdaError.textContent = err.message || 'Error calling Lambda';
      }
    });

    // On load, check auth state
    checkAuth();
  </script>
</body>
</html>
